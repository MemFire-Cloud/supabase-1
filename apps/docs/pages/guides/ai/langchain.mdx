import Layout from '~/layouts/DefaultGuideLayout'

export const meta = {
  id: 'ai-lang-chain',
  title: 'LangChain',
  description:
    'Learn how to integrate Supabase with LangChain, a popular framework for composing AI, Vectors, and embeddings',
  sidebar_label: 'LangChain',
}

[LangChain](langchain.com) 是一个用于处理AI、向量和嵌入的流行框架。LangChain 支持使用Supabase作为 [向量存储](https://js.langchain.com/docs/modules/indexes/vector_stores/integrations/supabase)，使用`pgvector`扩展。

## 初始化你的数据库

为你的数据库准备相关的表格：

<Tabs
  scrollable
  size="small"
  type="underlined"
  defaultActiveId="dashboard"
>
<TabPanel id="dashboard" label="控制台">

1. 跳转到控制台的 [SQL 编辑](https://supabase.com/dashboard/project/_/sql) 页面。
2. 在快速入门部分点击 **LangChain** 。
3. 点击 **运行**.

</TabPanel>

<TabPanel id="sql" label="SQL">

```sql
-- Enable the pgvector extension to work with embedding vectors
create extension vector;

-- Create a table to store your documents
create table documents (
  id bigserial primary key,
  content text, -- corresponds to Document.pageContent
  metadata jsonb, -- corresponds to Document.metadata
  embedding vector(1536) -- 1536 works for OpenAI embeddings, change if needed
);

-- Create a function to search for documents
create function match_documents (
  query_embedding vector(1536),
  match_count int default null,
  filter jsonb DEFAULT '{}'
) returns table (
  id bigint,
  content text,
  metadata jsonb,
  similarity float
)
language plpgsql
as $$
#variable_conflict use_column
begin
  return query
  select
    id,
    content,
    metadata,
    1 - (documents.embedding <=> query_embedding) as similarity
  from documents
  where metadata @> filter
  order by documents.embedding <=> query_embedding
  limit match_count;
end;
$$;
```

</TabPanel>
</Tabs>

## 使用方法
你现在可以使用任何Node.js应用程序搜索你的文档。这是设计在安全的服务器路由上运行的。

```js
import { SupabaseVectorStore } from 'langchain/vectorstores/supabase'
import { OpenAIEmbeddings } from 'langchain/embeddings/openai'
import { createClient } from '@supabase/supabase-js'

const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY
if (!supabaseKey) throw new Error(`Expected SUPABASE_SERVICE_ROLE_KEY`)

const url = process.env.SUPABASE_URL
if (!url) throw new Error(`Expected env var SUPABASE_URL`)

export const run = async () => {
  const client = createClient(url, supabaseKey)

  const vectorStore = await SupabaseVectorStore.fromTexts(
    ['Hello world', 'Bye bye', "What's this?"],
    [{ id: 2 }, { id: 1 }, { id: 3 }],
    new OpenAIEmbeddings(),
    {
      client,
      tableName: 'documents',
      queryName: 'match_documents',
    }
  )

  const resultOne = await vectorStore.similaritySearch('Hello world', 1)

  console.log(resultOne)
}
```

### 简单的元数据过滤

根据上述的 `match_documents`  Postgres函数，您还可以传递一个 filter 参数，只返回具有特定元数据字段值的文档。这个 filter 参数是一个JSON对象， `match_documents` 函数将使用 Postgres 的 JSONB 包含运算符 `@>` 来根据您指定的元数据字段值对文档进行过滤。有关更多信息，请参阅[ Postgres 的 JSONB 包含运算符](https://www.postgresql.org/docs/current/datatype-json.html#JSON-CONTAINMENT) 的详细说明。

```js
import { SupabaseVectorStore } from 'langchain/vectorstores/supabase'
import { OpenAIEmbeddings } from 'langchain/embeddings/openai'
import { createClient } from '@supabase/supabase-js'

// First, follow set-up instructions above

const privateKey = process.env.SUPABASE_SERVICE_ROLE_KEY
if (!privateKey) throw new Error(`Expected env var SUPABASE_SERVICE_ROLE_KEY`)

const url = process.env.SUPABASE_URL
if (!url) throw new Error(`Expected env var SUPABASE_URL`)

export const run = async () => {
  const client = createClient(url, privateKey)

  const vectorStore = await SupabaseVectorStore.fromTexts(
    ['Hello world', 'Hello world', 'Hello world'],
    [{ user_id: 2 }, { user_id: 1 }, { user_id: 3 }],
    new OpenAIEmbeddings(),
    {
      client,
      tableName: 'documents',
      queryName: 'match_documents',
    }
  )

  const result = await vectorStore.similaritySearch('Hello world', 1, {
    user_id: 3,
  })

  console.log(result)
}
```

### 高级的元数据过滤

你还可以使用查询构建器风格的过滤（[类似于 Supabase JavaScript 库的工作方式](https://supabase.com/docs/reference/javascript/using-filters)），而不是传递一个对象。请注意，由于过滤属性将位于元数据列中，你需要使用箭头运算符（`->` 表示整数， `->>` 表示文本），如 [Postgrest API 文档](https://postgrest.org/en/stable/references/api/tables_views.html?highlight=operators#json-columns) 中定义的那样，并指定属性的数据类型（例如，列应该看起来像 `metadata->some_int_value::int` ）。

```js
import { SupabaseFilterRPCCall, SupabaseVectorStore } from 'langchain/vectorstores/supabase'
import { OpenAIEmbeddings } from 'langchain/embeddings/openai'
import { createClient } from '@supabase/supabase-js'

// First, follow set-up instructions above

const privateKey = process.env.SUPABASE_SERVICE_ROLE_KEY
if (!privateKey) throw new Error(`Expected env var SUPABASE_SERVICE_ROLE_KEY`)

const url = process.env.SUPABASE_URL
if (!url) throw new Error(`Expected env var SUPABASE_URL`)

export const run = async () => {
  const client = createClient(url, privateKey)

  const embeddings = new OpenAIEmbeddings()

  const store = new SupabaseVectorStore(embeddings, {
    client,
    tableName: 'documents',
  })

  const docs = [
    {
      pageContent:
        'This is a long text, but it actually means something because vector database does not understand Lorem Ipsum. So I would need to expand upon the notion of quantum fluff, a theorectical concept where subatomic particles coalesce to form transient multidimensional spaces. Yet, this abstraction holds no real-world application or comprehensible meaning, reflecting a cosmic puzzle.',
      metadata: { b: 1, c: 10, stuff: 'right' },
    },
    {
      pageContent:
        'This is a long text, but it actually means something because vector database does not understand Lorem Ipsum. So I would need to proceed by discussing the echo of virtual tweets in the binary corridors of the digital universe. Each tweet, like a pixelated canary, hums in an unseen frequency, a fascinatingly perplexing phenomenon that, while conjuring vivid imagery, lacks any concrete implication or real-world relevance, portraying a paradox of multidimensional spaces in the age of cyber folklore.',
      metadata: { b: 2, c: 9, stuff: 'right' },
    },
    { pageContent: 'hello', metadata: { b: 1, c: 9, stuff: 'right' } },
    { pageContent: 'hello', metadata: { b: 1, c: 9, stuff: 'wrong' } },
    { pageContent: 'hi', metadata: { b: 2, c: 8, stuff: 'right' } },
    { pageContent: 'bye', metadata: { b: 3, c: 7, stuff: 'right' } },
    { pageContent: "what's this", metadata: { b: 4, c: 6, stuff: 'right' } },
  ]

  await store.addDocuments(docs)

  const funcFilterA: SupabaseFilterRPCCall = (rpc) =>
    rpc
      .filter('metadata->b::int', 'lt', 3)
      .filter('metadata->c::int', 'gt', 7)
      .textSearch('content', `'multidimensional' & 'spaces'`, {
        config: 'english',
      })

  const resultA = await store.similaritySearch('quantum', 4, funcFilterA)

  const funcFilterB: SupabaseFilterRPCCall = (rpc) =>
    rpc
      .filter('metadata->b::int', 'lt', 3)
      .filter('metadata->c::int', 'gt', 7)
      .filter('metadata->>stuff', 'eq', 'right')

  const resultB = await store.similaritySearch('hello', 2, funcFilterB)

  console.log(resultA, resultB)
}
```

## 混合搜索

LangChain支持混合搜索的概念，将相似度搜索和全文搜索结合在一起。阅读官方文档以开始使用：[Supabase混合搜索](https://js.langchain.com/docs/modules/indexes/retrievers/supabase-hybrid) 。

你可以通过我们的 [database.dev软件包管理器](https://database.dev/langchain/hybrid_search) 安装LangChain混合搜索。


## 相关资源

- [LangChain 官网](https://langchain.com/)
- [LangChain 官方文档](https://js.langchain.com/docs/modules/indexes/vector_stores/integrations/supabase)
- Supabase [混合搜索](https://js.langchain.com/docs/modules/indexes/retrievers/supabase-hybrid)

export const Page = ({ children }) => <Layout meta={meta} children={children} />

export default Page
